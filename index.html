<!DOCTYPE html>
<html lang="hy">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ողջի գետի ջրի որակ․ Ֆոնային vs Վերջնակետ (պահպանման գրաֆիկ)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <style>
    :root{
      --bg:#f4f6f8; --card:#fff; --ink:#1f2937; --muted:#6b7280; --accent:#0b7285;
      --border:#e5e7eb;
    }
    body{margin:0; font-family:Arial, Helvetica, sans-serif; background:var(--bg); color:var(--ink);}
    header{background:var(--accent); color:#fff; padding:18px 16px;}
    header h1{margin:0; font-size:20px; line-height:1.2}
    header p{margin:6px 0 0; opacity:.9; font-size:13px}

    .wrap{max-width:1200px; margin:0 auto; padding:14px;}
    .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; margin:12px 0;}
    .card h2{margin:0 0 10px; color:var(--accent); font-size:16px}
    .sub{color:var(--muted); font-size:13px; margin-top:-4px; margin-bottom:12px; line-height:1.5}

    .grid{display:grid; grid-template-columns: 1.1fr 1.9fr; gap:12px;}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr;} }

    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:end;}
    .ctrl{display:flex; flex-direction:column; gap:6px;}
    label{font-size:12px; color:var(--muted);}
    select, button{
      border:1px solid var(--border); border-radius:10px; padding:10px 10px; font-size:14px; background:#fff;
    }
    button{cursor:pointer; background:var(--accent); color:#fff; border-color:transparent;}
    button:hover{filter:brightness(0.95);}

    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .kpi .box{border:1px dashed var(--border); border-radius:12px; padding:10px;}
    .kpi .t{font-size:12px; color:var(--muted);}
    .kpi .v{font-size:16px; font-weight:700; margin-top:6px;}

    .note{font-size:12px; color:var(--muted); line-height:1.5;}
    footer{padding:14px; text-align:center; color:var(--muted); font-size:12px;}
    canvas{max-height:420px;}
    .legendHint{font-size:12px; color:var(--muted); margin-top:8px;}
  </style>
</head>

<body>
  <header>
    <h1>Պահպանման գրաֆիկ՝ ազդեցության գոտուց հետո (Ֆոնային vs Վերջնակետ)</h1>
    <p>Ֆիզիկաքիմիական և աղային ցուցիչներ․ համեմատվում են «Ողջի ջրառ (Ֆոնային)» և «Դարազամ/Ձորատեղ (վերջնակետ)» կետերը</p>
  </header>

  <div class="wrap">
    <div class="card">
      <h2>Ինչ է ցույց տալիս այս գրաֆիկը</h2>
      <div class="sub">
        Ընտրիր ցուցիչը, և գրաֆիկը կցուցադրի ժամանակային փոփոխությունը՝ <b>ֆոնային</b> կետի և <b>վերջնակետի</b> համար նույն օրերի վրա։
        Սա կարելի է օգտագործել հասկանալու համար՝ ազդեցության գոտուց հետո տվյալ ցուցիչը «վերականգնվում/պահպանվում» է դեպի ֆոնային մակարդակ, թե մնում է բարձր/ցածր։
      </div>
      <div class="note">
        * «&lt;x» արժեքները գրաֆիկում հաշվարկվում են որպես x/2 (միայն տեսանելիության համար) և tooltip-ում նշվում է, որ դա «մակարդակից ցածր» է։
      </div>
    </div>

    <div class="card">
      <h2>Պահպանման գրաֆիկ (Ֆոնային vs Վերջնակետ)</h2>

      <div class="controls">
        <div class="ctrl">
          <label for="category">Խումբ</label>
          <select id="category"></select>
        </div>

        <div class="ctrl">
          <label for="indicator">Ցուցիչ</label>
          <select id="indicator"></select>
        </div>

        <div class="ctrl">
          <label for="mode">Տեսք</label>
          <select id="mode">
            <option value="line">Ժամանակային գիծ</option>
            <option value="ratio">Վերջնակետ / Ֆոնային (հարաբերակցություն)</option>
          </select>
        </div>

        <button id="btnUpdate">Թարմացնել</button>
      </div>

      <div class="grid" style="margin-top:12px;">
        <div>
          <div class="kpi">
            <div class="box">
              <div class="t">Վերջին համընկնող օր (ֆոնային)</div>
              <div class="v" id="kpiBg">—</div>
            </div>
            <div class="box">
              <div class="t">Վերջին համընկնող օր (վերջնակետ)</div>
              <div class="v" id="kpiEnd">—</div>
            </div>
            <div class="box">
              <div class="t">Տարբերություն (վերջնակետ − ֆոնային)</div>
              <div class="v" id="kpiDiff">—</div>
            </div>
            <div class="box">
              <div class="t">Հարաբերակցություն (վերջնակետ / ֆոնային)</div>
              <div class="v" id="kpiRatio">—</div>
            </div>
          </div>

          <div class="legendHint">
            Հուշում․ «Վերջնակետ/Ֆոնային» &gt; 1 ⇒ վերջնակետում բարձր է, &lt; 1 ⇒ վերջնակետում ցածր է։
          </div>
        </div>

        <div>
          <canvas id="chart"></canvas>
        </div>
      </div>
    </div>

    <footer>
      Տվյալների աղբյուր՝ քո տրամադրած աղյուսակները (2025թ.) • Էջը ամբողջությամբ offline է (միայն Chart.js CDN)
    </footer>
  </div>

<script>
/** ========= Utils ========= **/
function parseValue(raw){
  if(raw === null || raw === undefined) return {val:null, raw:null, isBelow:false};
  const s = String(raw).trim();
  if(s === "" || s === "-" ) return {val:null, raw:s, isBelow:false};

  // Normalize comma decimals if any
  const ss = s.replace(",", ".");

  if(ss.startsWith("<")){
    const num = Number(ss.replace("<","").trim());
    if(Number.isFinite(num)) return {val: num/2, raw:s, isBelow:true};
    return {val:null, raw:s, isBelow:true};
  }
  const num = Number(ss);
  if(Number.isFinite(num)) return {val:num, raw:s, isBelow:false};
  return {val:null, raw:s, isBelow:false};
}

function formatMaybe(val){
  if(val === null || val === undefined || !Number.isFinite(val)) return "—";
  // avoid too many decimals
  const abs = Math.abs(val);
  if(abs >= 100) return val.toFixed(1);
  if(abs >= 10) return val.toFixed(2);
  if(abs >= 1) return val.toFixed(3);
  return val.toFixed(4);
}

function sortDates(dates){
  // dates in dd.mm.yyyy
  return dates.slice().sort((a,b)=>{
    const [da,ma,ya] = a.split(".").map(Number);
    const [db,mb,yb] = b.split(".").map(Number);
    const A = new Date(ya, ma-1, da).getTime();
    const B = new Date(yb, mb-1, db).getTime();
    return A-B;
  });
}

function intersectDates(aDates, bDates){
  const setB = new Set(bDates);
  return aDates.filter(d => setB.has(d));
}

/** ========= Data (only phys-chem + saline indicators you requested) ========= **/
const stations = {
  background: {
    name: "Ողջի ջրառ (Ֆոնային)",
    data: {
      "Թափանցիկություն (աստիճան)": {
        "25.03.2025": "31","22.04.2025":"31","13.05.2025":"31","17.06.2025":"31","15.07.2025":"31","12.08.2025":"31","16.09.2025":"31","14.10.2025":"31","18.11.2025":"31"
      },
      "Կախութային չոր նյութեր (մգ/լ)": {
        "25.03.2025":"12.5","22.04.2025":"36.1","13.05.2025":"16","17.06.2025":"6.3","15.07.2025":"8.8","12.08.2025":"10.8","16.09.2025":"9","14.10.2025":"17.7","18.11.2025":"3.2"
      },
      "Ջրածնային ցուցիչ (pH)": {
        "25.03.2025":"8.05","22.04.2025":"7.64","13.05.2025":"7.57","17.06.2025":"7.54","15.07.2025":"7.736","12.08.2025":"8.2","16.09.2025":"7.88","14.10.2025":"8.058","18.11.2025":"7.993"
      },
      "Ընդհանուր կոշտություն (մգ/լ)": {
        "25.03.2025":"2.0251","22.04.2025":"0.9905","13.05.2025":"0.6673","17.06.2025":"0.6705","15.07.2025":"1.0249","12.08.2025":"3.2071","16.09.2025":"1.8228","14.10.2025":"2.1174","18.11.2025":"1.6011"
      },

      "Կարբոնատ (մգ/լ)": {
        "25.03.2025":"14.25","22.04.2025":"12","13.05.2025":"12","17.06.2025":"9","15.07.2025":"13.5","12.08.2025":"18","16.09.2025":"15","14.10.2025":"15","18.11.2025":"14.25"
      },
      "Սուլֆատ իոն (մգ/լ)": {
        "25.03.2025":"23.56","22.04.2025":"9.48","13.05.2025":"6.58","17.06.2025":"7.71","15.07.2025":"9.64","12.08.2025":"45.05","16.09.2025":"21.30","14.10.2025":"23.71","18.11.2025":"21.57"
      },
      "Քլորիդ իոն (մգ/լ)": {
        "25.03.2025":"6.23","22.04.2025":"2.16","13.05.2025":"1.38","17.06.2025":"1.22","15.07.2025":"1.11","12.08.2025":"4.51","16.09.2025":"3.53","14.10.2025":"3.98","18.11.2025":"3.88"
      },
      "Ֆտորիդ իոն (մգ/լ)": {
        "25.03.2025":"0.2358","22.04.2025":"0.085","13.05.2025":"0.1013","17.06.2025":"0.0555","15.07.2025":"0.08","12.08.2025":"0.18","16.09.2025":"0.116","14.10.2025":"0.097","18.11.2025":"0.108"
      },
      "Նիտրատ իոն (մգ/լ)": {
        "25.03.2025":"2.1888","22.04.2025":"2.419","13.05.2025":"1.5849","17.06.2025":"1.3139","15.07.2025":"0.495","12.08.2025":"0.33","16.09.2025":"0.535","14.10.2025":"0.653","18.11.2025":"1.321"
      },
      "Նիտրիտ իոն (մգ/լ)": {
        "25.03.2025":"<0.013","22.04.2025":"<0.013","13.05.2025":"<0.013","17.06.2025":"0.013724211","15.07.2025":"<0.013","12.08.2025":"0.01451602","16.09.2025":"0.008997533","14.10.2025":"0.009477401","18.11.2025":"0.01982273"
      },
      "Ամոնիում իոն (մգ/լ)": {
        "25.03.2025":"0.097","22.04.2025":"0.104","13.05.2025":"0.060","17.06.2025":"0.055","15.07.2025":"0.038","12.08.2025":"0.177","16.09.2025":"0.067","14.10.2025":"0.149","18.11.2025":"0.033"
      },
      "Ընդհանուր անօրգանական ազոտ (մգ N/լ)": {
        "25.03.2025":"0.571","22.04.2025":"0.627","13.05.2025":"0.405","17.06.2025":"0.344","15.07.2025":"0.141","12.08.2025":"0.217","16.09.2025":"0.176","14.10.2025":"0.266","18.11.2025":"0.330"
      },
      "Ֆոսֆատներ (մգ/լ)": {
        "25.03.2025":"0.00467172","22.04.2025":"0.0103816","13.05.2025":"0.00484065","17.06.2025":"0.00484065","15.07.2025":"0.010757","12.08.2025":"0.03029376","16.09.2025":"0.0784392","14.10.2025":"0.01514688","18.11.2025":"<0.004"
      },
      "ԹԿՊ5 (BOD5) (մգ/լ)": {
        "25.03.2025":"2.34","22.04.2025":"2.67","13.05.2025":"2.57","17.06.2025":"1.89","15.07.2025":"1.81","12.08.2025":"1.51","16.09.2025":"2.46","14.10.2025":"3.4","18.11.2025":"4.14"
      },
      "Բիքրոմատային օքսիդացում (COD) (մգ Օ/լ)": {
        "25.03.2025":"10","22.04.2025":"10","13.05.2025":"50","17.06.2025":"5","15.07.2025":"5","12.08.2025":"10","16.09.2025":"10","14.10.2025":"5","18.11.2025":"5"
      },
      "Տեսակարար էլեկտրահաղորդականություն (µS/սմ)": {
        "25.03.2025":"314","22.04.2025":"140.9","13.05.2025":"83.2","17.06.2025":"82.6","15.07.2025":"119.4","12.08.2025":"402","16.09.2025":"227","14.10.2025":"257","18.11.2025":"261"
      },
      "Հիդրոկարբոնատ իոն (մգ/լ)": {
        "25.03.2025":"140.35","22.04.2025":"54.92","13.05.2025":"33.56","17.06.2025":"53.69","15.07.2025":"54.92","12.08.2025":"189.16","16.09.2025":"106.79","14.10.2025":"122.04","18.11.2025":"112.89"
      },
      "Հանքայնացում (ԸԼՆ) (մգ/լ)": {
        "25.03.2025":"204","22.04.2025":"92","13.05.2025":"54","17.06.2025":"36.612","15.07.2025":"77.61","12.08.2025":"261.3","16.09.2025":"147.55","14.10.2025":"167.05","18.11.2025":"169.65"
      }
    }
  },

  endpoint: {
    name: "Դարազամ/Ձորատեղ (վերջնակետ)",
    data: {
      "Թափանցիկություն (աստիճան)": {
        "29.01.2025":"31","25.02.2025":"3","25.03.2025":"31","22.04.2025":"4","13.05.2025":"31","17.06.2025":"31","15.07.2025":"31","12.08.2025":"31","16.09.2025":"31","14.10.2025":"31","18.11.2025":"31"
      },
      "Կախութային չոր նյութեր (մգ/լ)": {
        "29.01.2025":"34.9","25.02.2025":"520.9","25.03.2025":"37.2","22.04.2025":"247.2","13.05.2025":"33","17.06.2025":"31.7","15.07.2025":"33.4","12.08.2025":"21.8","16.09.2025":"43.3","14.10.2025":"45.1","18.11.2025":"17.1"
      },
      "Ջրածնային ցուցիչ (pH)": {
        "29.01.2025":"8.18","25.02.2025":"8.09","25.03.2025":"8.22","22.04.2025":"8.07","13.05.2025":"8.04","17.06.2025":"8.06","15.07.2025":"7.987","12.08.2025":"7.998","16.09.2025":"8.017","14.10.2025":"8.105","18.11.2025":"8.096"
      },
      "Ընդհանուր կոշտություն (մգ/լ)": {
        "29.01.2025":"37.48","25.02.2025":"34.58","25.03.2025":"20.67","22.04.2025":"15.05","13.05.2025":"16.85","17.06.2025":"23.18","15.07.2025":"23.71","12.08.2025":"28.87","16.09.2025":"26.21","14.10.2025":"32.40","18.11.2025":"32.53"
      },

      "Կարբոնատ (մգ/լ)": {
        "29.01.2025":"21.75","25.02.2025":"24.75","25.03.2025":"26.25","22.04.2025":"21.75","13.05.2025":"23.25","17.06.2025":"28.5","15.07.2025":"30.75","12.08.2025":"30.75","16.09.2025":"32.25","14.10.2025":"30.75","18.11.2025":"27"
      },
      "Սուլֆատ իոն (մգ/լ)": {
        "29.01.2025":"1463.16","25.02.2025":"1410.75","25.03.2025":"815.97","22.04.2025":"538.89","13.05.2025":"495.10","17.06.2025":"723.14","15.07.2025":"885.74","12.08.2025":"1093.59","16.09.2025":"940.38","14.10.2025":"1130.79","18.11.2025":"1398.69"
      },
      "Քլորիդ իոն (մգ/լ)": {
        "29.01.2025":"45.98","25.02.2025":"42.72","25.03.2025":"61.56","22.04.2025":"52.88","13.05.2025":"64.72","17.06.2025":"61.22","15.07.2025":"42.38","12.08.2025":"42.73","16.09.2025":"37.64","14.10.2025":"44.31","18.11.2025":"46.25"
      },
      "Ֆտորիդ իոն (մգ/լ)": {
        "29.01.2025":"3.159","25.02.2025":"3.076","25.03.2025":"1.6272","22.04.2025":"0.988","13.05.2025":"1.3946","17.06.2025":"1.3635","15.07.2025":"2.229","12.08.2025":"2.258","16.09.2025":"2.415","14.10.2025":"2.445","18.11.2025":"2.421"
      },
      "Նիտրատ իոն (մգ/լ)": {
        "29.01.2025":"70.70","25.02.2025":"80.04","25.03.2025":"69.27","22.04.2025":"37.66","13.05.2025":"38.03","17.06.2025":"56.38","15.07.2025":"47.16","12.08.2025":"60.59","16.09.2025":"34.51","14.10.2025":"52.40","18.11.2025":"116.24"
      },
      "Նիտրիտ իոն (մգ/լ)": {
        "29.01.2025":"<0.013","25.02.2025":"0.057437171","25.03.2025":"0.035544079","22.04.2025":"<0.013","13.05.2025":"0.013724211","17.06.2025":"0.020456842","15.07.2025":"<0.013","12.08.2025":"0.040069013","16.09.2025":"0.02651273","14.10.2025":"0.030231711","18.11.2025":"0.039037401"
      },
      "Ամոնիում իոն (մգ/լ)": {
        "29.01.2025":"2.288","25.02.2025":"1.543","25.03.2025":"3.341","22.04.2025":"0.998","13.05.2025":"2.137","17.06.2025":"1.179","15.07.2025":"1.135","12.08.2025":"3.153","16.09.2025":"4.575","14.10.2025":"1.550","18.11.2025":"1.754"
      },
      "Ընդհանուր անօրգանական ազոտ (մգ N/լ)": {
        "29.01.2025":"17.74","25.02.2025":"19.29","25.03.2025":"18.25","22.04.2025":"9.28","13.05.2025":"10.25","17.06.2025":"13.65","15.07.2025":"11.53","12.08.2025":"16.15","16.09.2025":"11.36","14.10.2025":"13.05","18.11.2025":"27.62"
      },
      "Ֆոսֆատներ (մգ/լ)": {
        "29.01.2025":"<0.004","25.02.2025":"0.01349608","25.03.2025":"0.012977","22.04.2025":"0.01712964","13.05.2025":"0.01237055","17.06.2025":"0.00484065","15.07.2025":"0.0204383","12.08.2025":"0.02867088","16.09.2025":"0.10927392","14.10.2025":"0.10386432","18.11.2025":"0.01612558"
      },
      "ԹԿՊ5 (BOD5) (մգ/լ)": {
        "29.01.2025":"3.33","25.02.2025":"3.34","25.03.2025":"3.09","22.04.2025":"2.44","13.05.2025":"2.26","17.06.2025":"2.08","15.07.2025":"1.62","12.08.2025":"2.21","16.09.2025":"3.31","14.10.2025":"3.11","18.11.2025":"4.41"
      },
      "Բիքրոմատային օքսիդացում (COD) (մգ Օ/լ)": {
        "29.01.2025":"15","25.02.2025":"10","25.03.2025":"20","22.04.2025":"10","13.05.2025":"10","17.06.2025":"15","15.07.2025":"15","12.08.2025":"15","16.09.2025":"15","14.10.2025":"20","18.11.2025":"20"
      },
      "Տեսակարար էլեկտրահաղորդականություն (µS/սմ)": {
        "29.01.2025":"3048","25.02.2025":"2966","25.03.2025":"2810","22.04.2025":"1617","13.05.2025":"2006","17.06.2025":"2496","15.07.2025":"2806","12.08.2025":"2978","16.09.2025":"2834","14.10.2025":"2716","18.11.2025":"3396"
      },
      "Հիդրոկարբոնատ իոն (մգ/լ)": {
        "29.01.2025":"329.51","25.02.2025":"256.28","25.03.2025":"237.98","22.04.2025":"210.52","13.05.2025":"250.18","17.06.2025":"1622.40","15.07.2025":"335.61","12.08.2025":"341.71","16.09.2025":"366.12","14.10.2025":"353.92","18.11.2025":"341.71"
      },
      "Հանքայնացում (ԸԼՆ) (մգ/լ)": {
        "29.01.2025":"1981","25.02.2025":"1928","25.03.2025":"1827","22.04.2025":"1051","13.05.2025":"1304","17.06.2025":"305.1","15.07.2025":"1824","12.08.2025":"1935.7","16.09.2025":"1842.1","14.10.2025":"1765.4","18.11.2025":"2207.4"
      }
    }
  }
};

/** ========= Categories ========= **/
const categories = {
  "Ֆիզիկաքիմիական": [
    "Թափանցիկություն (աստիճան)",
    "Կախութային չոր նյութեր (մգ/լ)",
    "Ջրածնային ցուցիչ (pH)",
    "Ընդհանուր կոշտություն (մգ/լ)",
    "ԹԿՊ5 (BOD5) (մգ/լ)",
    "Բիքրոմատային օքսիդացում (COD) (մգ Օ/լ)",
    "Տեսակարար էլեկտրահաղորդականություն (µS/սմ)"
  ],
  "Աղային ցուցիչներ": [
    "Կարբոնատ (մգ/լ)",
    "Հիդրոկարբոնատ իոն (մգ/լ)",
    "Սուլֆատ իոն (մգ/լ)",
    "Քլորիդ իոն (մգ/լ)",
    "Ֆտորիդ իոն (մգ/լ)",
    "Հանքայնացում (ԸԼՆ) (մգ/լ)"
  ],
  "Ազոտ և ֆոսֆոր": [
    "Նիտրատ իոն (մգ/լ)",
    "Նիտրիտ իոն (մգ/լ)",
    "Ամոնիում իոն (մգ/լ)",
    "Ընդհանուր անօրգանական ազոտ (մգ N/լ)",
    "Ֆոսֆատներ (մգ/լ)"
  ]
};

/** ========= UI Setup ========= **/
const elCategory = document.getElementById("category");
const elIndicator = document.getElementById("indicator");
const elMode = document.getElementById("mode");
const btn = document.getElementById("btnUpdate");

function fillCategories(){
  elCategory.innerHTML = "";
  Object.keys(categories).forEach((k)=>{
    const opt = document.createElement("option");
    opt.value = k; opt.textContent = k;
    elCategory.appendChild(opt);
  });
}

function fillIndicators(){
  const cat = elCategory.value;
  const list = categories[cat] || [];
  elIndicator.innerHTML = "";
  list.forEach((name)=>{
    const opt = document.createElement("option");
    opt.value = name; opt.textContent = name;
    elIndicator.appendChild(opt);
  });
}

/** ========= Chart ========= **/
let chart = null;

function buildSeries(indName){
  const bg = stations.background.data[indName] || {};
  const end = stations.endpoint.data[indName] || {};

  const allDates = sortDates(Array.from(new Set([...Object.keys(bg), ...Object.keys(end)])));
  const overlapDates = intersectDates(Object.keys(bg), Object.keys(end));
  const overlapSorted = sortDates(overlapDates);

  const bgParsed = allDates.map(d => parseValue(bg[d] ?? null));
  const endParsed = allDates.map(d => parseValue(end[d] ?? null));

  return { allDates, bgParsed, endParsed, overlapSorted, bgRaw:bg, endRaw:end };
}

function updateKPI(indName){
  const series = buildSeries(indName);
  const overlap = series.overlapSorted;
  if(overlap.length === 0){
    document.getElementById("kpiBg").textContent = "—";
    document.getElementById("kpiEnd").textContent = "—";
    document.getElementById("kpiDiff").textContent = "—";
    document.getElementById("kpiRatio").textContent = "—";
    return;
  }
  const last = overlap[overlap.length-1];
  const bg = parseValue(stations.background.data[indName]?.[last]);
  const ed = parseValue(stations.endpoint.data[indName]?.[last]);

  document.getElementById("kpiBg").textContent = `${last}: ${bg.raw ?? "—"}${bg.isBelow ? " (ցածր սահման)" : ""}`;
  document.getElementById("kpiEnd").textContent = `${last}: ${ed.raw ?? "—"}${ed.isBelow ? " (ցածր սահման)" : ""}`;

  const diff = (ed.val!==null && bg.val!==null) ? (ed.val - bg.val) : null;
  const ratio = (ed.val!==null && bg.val!==null && bg.val!==0) ? (ed.val / bg.val) : null;

  document.getElementById("kpiDiff").textContent = formatMaybe(diff);
  document.getElementById("kpiRatio").textContent = formatMaybe(ratio);
}

function renderChart(){
  const indName = elIndicator.value;
  const mode = elMode.value;

  const { allDates, bgParsed, endParsed } = buildSeries(indName);

  const labels = allDates;

  const bgVals = bgParsed.map(x => x.val);
  const endVals = endParsed.map(x => x.val);

  const ratioVals = labels.map((d, i)=>{
    const a = bgVals[i];
    const b = endVals[i];
    if(a === null || b === null || !Number.isFinite(a) || !Number.isFinite(b) || a === 0) return null;
    return b / a;
  });

  const data = (mode === "ratio")
    ? {
        labels,
        datasets: [
          {
            label: "Վերջնակետ / Ֆոնային",
            data: ratioVals,
            spanGaps: true,
            tension: 0.25
          }
        ]
      }
    : {
        labels,
        datasets: [
          {
            label: stations.background.name,
            data: bgVals,
            spanGaps: true,
            tension: 0.25
          },
          {
            label: stations.endpoint.name,
            data: endVals,
            spanGaps: true,
            tension: 0.25
          }
        ]
      };

  const tooltipFooter = (items)=>{
    // show original raw values and "<" note
    const idx = items?.[0]?.dataIndex;
    if(idx === undefined) return "";
    const d = labels[idx];
    const bgRaw = stations.background.data[indName]?.[d] ?? "—";
    const enRaw = stations.endpoint.data[indName]?.[d] ?? "—";
    if(mode === "ratio"){
      return `Ֆոնային: ${bgRaw} | Վերջնակետ: ${enRaw}`;
    }
    return `Ֆոնային: ${bgRaw} | Վերջնակետ: ${enRaw}`;
  };

  const options = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: "top" },
      tooltip: {
        callbacks: { footer: tooltipFooter }
      },
      title: {
        display: true,
        text: (mode === "ratio")
          ? `${indName} — Վերջնակետ/Ֆոնային հարաբերակցություն`
          : `${indName} — Ֆոնային vs Վերջնակետ`
      }
    },
    scales: {
      x: { ticks: { maxRotation: 0, autoSkip: true } },
      y: { beginAtZero: false }
    }
  };

  const ctx = document.getElementById("chart");
  if(chart) chart.destroy();
  chart = new Chart(ctx, { type: "line", data, options });

  updateKPI(indName);
}

/** ========= Init ========= **/
fillCategories();
fillIndicators();

elCategory.addEventListener("change", ()=>{
  fillIndicators();
  renderChart();
});
btn.addEventListener("click", renderChart);
elMode.addEventListener("change", renderChart);

// initial
renderChart();
</script>
</body>
</html>
